<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Golf Schläger Empfehlung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- PWA / Icon -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <meta name="theme-color" content="#22c55e">

    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, #c8f3d8 0, #f5f7fb 45%, #dfe9f3 100%);
        }

        .app {
            background: #ffffff;
            padding: 16px 16px 20px;
            border-radius: 18px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
            max-width: 950px;
            width: 100%;
            box-sizing: border-box;
        }

        h1 {
            margin: 8px 0 4px;
            font-size: 22px;
            text-align: center;
        }

        .subtitle {
            margin: 0 0 12px;
            text-align: center;
            font-size: 13px;
            color: #64748b;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin: 16px 0 6px;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #e0f2fe;
            color: #0369a1;
            font-weight: 500;
        }

        label {
            font-size: 13px;
            display: block;
            margin-bottom: 4px;
            color: #0f172a;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
            background: #ffffff;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        button {
            padding: 8px 12px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
            box-shadow: 0 8px 20px rgba(22, 163, 74, 0.35);
        }

        button:hover {
            filter: brightness(1.03);
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(22, 163, 74, 0.4);
        }

        button:active {
            transform: translateY(1px);
            box-shadow: 0 4px 14px rgba(22, 163, 74, 0.3);
        }

        .primary-button {
            width: 100%;
        }

        .secondary-button {
            background: #0f172a;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.35);
            font-size: 13px;
        }

        .ghost-button {
            background: #f8fafc;
            color: #0f172a;
            box-shadow: none;
            border: 1px solid #cbd5e1;
        }

        .outline-button {
            background: transparent;
            color: #0f172a;
            box-shadow: none;
            border: 1px solid #cbd5e1;
        }

        .field-group {
            margin-bottom: 10px;
        }

        .flex-row {
            display: flex;
            gap: 10px;
        }

        .flex-row .field-group {
            flex: 1;
            margin-bottom: 0;
        }

        #result {
            margin-top: 10px;
            font-weight: 600;
            font-size: 15px;
            padding: 8px 10px;
            border-radius: 10px;
            background: #f1f5f9;
            color: #0f172a;
        }

        .result-empty {
            background: transparent;
            padding: 0;
        }

        .hint {
            margin-top: 4px;
            font-size: 11px;
            color: #64748b;
        }

        .small-hint {
            margin-top: 2px;
            font-size: 11px;
            color: #94a3b8;
        }

        .club-list,
        .round-section {
            margin-top: 12px;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
        }

        th, td {
            padding: 4px 6px;
            text-align: left;
            font-size: 12px;
        }

        thead {
            background: #f1f5f9;
        }

        th {
            font-weight: 600;
            color: #0f172a;
        }

        tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        tbody tr:nth-child(odd) {
            background: #ffffff;
        }

        .club-input {
            width: 80px;
            padding: 4px 6px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 12px;
            box-sizing: border-box;
        }

        .club-input:focus {
            border-color: #22c55e;
            outline: none;
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25);
        }

        .club-name {
            white-space: nowrap;
        }

        .delete-btn {
            background: transparent;
            border-radius: 999px;
            border: none;
            padding: 2px 6px;
            box-shadow: none;
            color: #dc2626;
            font-size: 14px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #fee2e2;
        }

        .status-message {
            margin-top: 4px;
            font-size: 11px;
            color: #16a34a;
        }

        .status-error {
            color: #dc2626;
        }

        .round-table-wrapper {
            max-height: 360px;
            overflow: auto;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            padding: 4px;
        }

        .round-input {
            width: 60px;
            font-size: 12px;
            padding: 3px 4px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            box-sizing: border-box;
        }

        .round-input:focus {
            border-color: #22c55e;
            outline: none;
        }

        .round-select {
            width: 120px;
            font-size: 12px;
            padding: 3px 4px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            box-sizing: border-box;
            background: #ffffff;
        }

        .round-summary {
            margin-top: 8px;
            font-size: 12px;
            color: #0f172a;
        }

        .round-summary strong {
            font-weight: 600;
        }

        .round-button-row {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .round-button-row button {
            flex: 1 1 30%;
        }

        /* NAVBAR / TABS */

        .navbar {
            display: flex;
            background: #ffffff;
            border-radius: 999px;
            border: 1px solid #e2e8f0;
            padding: 4px;
            gap: 6px;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .navbar button {
            flex: 1;
            padding: 6px 8px;
            border-radius: 999px;
            border: none;
            background: #f1f5f9;
            color: #0f172a;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: none;
            margin-top: 0;
        }

        .navbar button.active {
            background: #22c55e;
            color: white;
        }

        .tab {
            display: none;
        }

        .tab.active {
            display: block;
        }

        .divider {
            height: 1px;
            background: #e2e8f0;
            margin: 10px 0 6px;
        }

        .setting-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .setting-row label {
            margin-bottom: 0;
        }

        .setting-row .setting-label {
            flex: 0 0 140px;
            font-size: 13px;
            color: #0f172a;
        }

        .setting-row .setting-input {
            flex: 1;
        }

        .checkbox-center {
            text-align: center;
        }

        .checkbox-center input {
            transform: scale(1.1);
        }

        .club-highlight {
            background: #dcfce7 !important;
        }

        /* LOGIN-OVERLAY */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 18px;
            padding: 20px 18px;
            width: 320px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            color: #e2e8f0;
            text-align: center;
        }

        .login-title {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .login-subtitle {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 14px;
        }

        .login-input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #334155;
            background: #020617;
            color: #e2e8f0;
            font-size: 14px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        .login-input:focus {
            border-color: #22c55e;
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
        }

        .login-button {
            width: 100%;
            margin-top: 6px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 10px 30px rgba(22, 163, 74, 0.6);
        }

        .login-error {
            font-size: 12px;
            color: #f97316;
            min-height: 16px;
            margin-top: 4px;
        }

    </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="login-overlay">
    <div class="login-card">
        <div class="login-title">Golf Caddy Login</div>
        <div class="login-subtitle">Zugriff nur für freigegebene Nutzer.</div>
        <input id="loginPassword" type="password" class="login-input" placeholder="Passwort eingeben" />
        <button id="loginButton" class="login-button">Anmelden</button>
        <div id="loginError" class="login-error"></div>
    </div>
</div>

<div class="app">

    <nav class="navbar">
        <button data-tab="tab-home" class="active">Home</button>
        <button data-tab="tab-bag">Bag</button>
        <button data-tab="tab-calibrate">Kalibrierung</button>
        <button data-tab="tab-round">Runde</button>
        <button data-tab="tab-settings">Settings</button>
    </nav>

    <h1>Golf Schläger Empfehlung</h1>
    <p class="subtitle">
        Distanz eingeben, Wind & Höhe berücksichtigen, Schläger wählen – Runde tracken und auswerten.
    </p>

    <!-- TAB: HOME -->
    <div id="tab-home" class="tab active">
        <div class="section-title">
            Distanz & Bedingungen
            <span class="badge">Flight-Check</span>
        </div>

        <div class="field-group">
            <label for="distanceInput">
                Entfernung zur Fahne (<span id="unitLabelHome">m</span>):
            </label>
            <input id="distanceInput" type="number" min="1" step="1" placeholder="z.&nbsp;B. 145" />
            <p class="hint">
                Gemessene Distanz vom Laser/Entfernungsmesser eintragen.
            </p>
        </div>

        <div class="flex-row">
            <div class="field-group">
                <label for="windSelect">Wind:</label>
                <select id="windSelect">
                    <option value="0">Kein/neutral</option>
                    <option value="5">Leichter Gegenwind (+5 m)</option>
                    <option value="10">Starker Gegenwind (+10 m)</option>
                    <option value="-5">Leichter Rückenwind (-5 m)</option>
                    <option value="-10">Starker Rückenwind (-10 m)</option>
                </select>
                <p class="small-hint">
                    Windanpassung wird mit deinem Wind-Faktor multipliziert.
                </p>
            </div>
            <div class="field-group">
                <label for="heightInput">
                    Höhenunterschied (<span id="unitLabelHeight">m</span>):
                </label>
                <input id="heightInput" type="number" step="1" placeholder="z.&nbsp;B. +5 bergauf" />
                <p class="small-hint">Positiv = bergauf, negativ = bergab.</p>
            </div>
        </div>

        <button id="calcButton" class="primary-button">Schläger berechnen</button>

        <div id="result" class="result-empty"></div>
    </div>

    <!-- TAB: BAG -->
    <div id="tab-bag" class="tab">
        <div class="section-title">
            Deine Schlägerweiten
            <span class="badge">Editierbar</span>
        </div>
        <p class="hint">
            Distanzen gelten in <span id="unitLabelBag">m</span> (intern in Meter gespeichert).
        </p>

        <div class="club-list">
            <table id="clubTable">
                <thead>
                <tr>
                    <th>Schläger</th>
                    <th>Distanz (<span id="unitLabelBagTable">m</span>)</th>
                    <th>Aktion</th>
                </tr>
                </thead>
                <tbody>
                <!-- JS -->
                </tbody>
            </table>
            <div id="saveStatus" class="status-message" style="display:none;"></div>
        </div>

        <div class="subsection">
            <div class="section-title">
                Schläger hinzufügen
                <span class="badge">Bag-Setup</span>
            </div>
            <div class="field-group">
                <label for="newClubNameInput">Schlägername:</label>
                <input id="newClubNameInput" type="text" placeholder="z.&nbsp;B. Gap Wedge, Hybrid 4" />
            </div>
            <div class="field-group">
                <label for="newClubDistanceInput">
                    Distanz (<span id="unitLabelNewClub">m</span>):
                </label>
                <input id="newClubDistanceInput" type="number" min="1" step="1" placeholder="z.&nbsp;B. 105" />
            </div>
            <button id="addClubButton" class="secondary-button">Schläger zum Bag hinzufügen</button>
            <div id="addClubStatus" class="status-message" style="display:none;"></div>
        </div>
    </div>

    <!-- TAB: KALIBRIERUNG -->
    <div id="tab-calibrate" class="tab">
        <div class="section-title">
            Bag-Check / Kalibrierung
            <span class="badge">Smart</span>
        </div>
        <p class="hint">
            Nach der Runde: Trage ein, was du wirklich geschlagen hast. Die App passt automatisch die Schlägerweite an.
        </p>

        <div class="subsection">
            <div class="field-group">
                <label for="clubSelect">Gespielter Schläger:</label>
                <select id="clubSelect">
                    <!-- JS -->
                </select>
            </div>
            <div class="field-group">
                <label for="shotDistanceInput">
                    Tatsächliche Distanz (<span id="unitLabelShot">m</span>):
                </label>
                <input id="shotDistanceInput" type="number" min="1" step="1" placeholder="z.&nbsp;B. 152" />
                <p class="small-hint">Wird automatisch geglättet in die Durchschnittsweite eingerechnet.</p>
            </div>
            <button id="saveShotButton" class="secondary-button">Bag-Check übernehmen</button>
            <div id="calibrationStatus" class="status-message" style="display:none;"></div>
        </div>
    </div>

    <!-- TAB: RUNDE -->
    <div id="tab-round" class="tab">
        <div class="section-title">
            Runde tracken (Loch 1–18)
            <span class="badge">Score-Card</span>
        </div>
        <p class="hint">
            Distanz, Par, Schläger, Score, Putts &amp; GIR/FIR erfassen.
            Distanz in <span id="unitLabelRound">m</span>.
        </p>

        <div class="round-section">
            <div class="round-table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>Loch</th>
                        <th>Distanz</th>
                        <th>Par</th>
                        <th>Schläger</th>
                        <th>Score</th>
                        <th>Putts</th>
                        <th>GIR</th>
                        <th>FIR</th>
                    </tr>
                    </thead>
                    <tbody id="roundTableBody">
                    <!-- JS -->
                    </tbody>
                </table>
            </div>

            <div class="round-button-row">
                <button id="analyzeRoundButton" class="secondary-button">Runde auswerten</button>
                <button id="exportRoundButton" class="outline-button">Runde als CSV exportieren</button>
                <button id="resetRoundButton" class="ghost-button">Runde zurücksetzen</button>
            </div>

            <div id="roundSummary" class="round-summary"></div>
        </div>
    </div>

    <!-- TAB: SETTINGS -->
    <div id="tab-settings" class="tab">
        <div class="section-title">
            Einstellungen
            <span class="badge">Beta</span>
        </div>

        <div class="setting-row">
            <div class="setting-label">Einheit:</div>
            <div class="setting-input">
                <select id="unitSelect">
                    <option value="m">Meter</option>
                    <option value="yd">Yards</option>
                </select>
                <p class="small-hint">
                    Eingaben & Anzeigen werden in dieser Einheit dargestellt (intern Meter).
                </p>
            </div>
        </div>

        <div class="setting-row">
            <div class="setting-label">Wind-Faktor:</div>
            <div class="setting-input">
                <input id="windFactorInput" type="number" step="0.1" min="0" value="1" />
                <p class="small-hint">
                    1.0 = Standard, 1.5 = Wind stärker gewichten, 0.5 = Wind weniger.
                </p>
            </div>
        </div>
    </div>

</div>

<script>
    // ===== LOGIN CONFIG =====
    // ÄNDERE HIER DEIN PASSWORT:
    const ACCESS_PASSWORDhei = "Abgolfen!"; // <--- anpassen!

    const LOGIN_STORAGE_KEY = "golfCaddyAuthorized";

    // Basisdaten
    const defaultClubs = [
        { name: "Driver", distance: 220 },
        { name: "Holz 3", distance: 200 },
        { name: "Eisen 4", distance: 180 },
        { name: "Eisen 5", distance: 170 },
        { name: "Eisen 6", distance: 160 },
        { name: "Eisen 7", distance: 150 },
        { name: "Eisen 8", distance: 140 },
        { name: "Eisen 9", distance: 130 },
        { name: "Pitching Wedge", distance: 110 },
        { name: "Sand Wedge", distance: 90 }
    ];

    let clubs = [];
    let unit = "m"; // "m" oder "yd"
    let windFactor = 1.0;

    const YARD_TO_METER = 0.9144;

    function loadSettings() {
        const u = localStorage.getItem("golfUnit");
        if (u === "m" || u === "yd") {
            unit = u;
        }
        const wf = parseFloat(localStorage.getItem("golfWindFactor"));
        if (!isNaN(wf) && wf >= 0) {
            windFactor = wf;
        }
    }

    function saveSettings() {
        localStorage.setItem("golfUnit", unit);
        localStorage.setItem("golfWindFactor", String(windFactor));
    }

    function toMeters(value) {
        if (isNaN(value)) return 0;
        return unit === "yd" ? value * YARD_TO_METER : value;
    }

    function fromMeters(value) {
        if (unit === "yd") {
            return value / YARD_TO_METER;
        }
        return value;
    }

    function loadClubs() {
        const saved = localStorage.getItem("golfClubs");
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                if (Array.isArray(parsed) && parsed.every(c => c.name && typeof c.distance === "number")) {
                    clubs = parsed;
                    return;
                }
            } catch (e) {
                console.warn("Konnte gespeicherte Clubs nicht lesen, nehme Standardwerte.", e);
            }
        }
        clubs = JSON.parse(JSON.stringify(defaultClubs));
    }

    function saveClubs() {
        localStorage.setItem("golfClubs", JSON.stringify(clubs));
        const status = document.getElementById("saveStatus");
        if (status) {
            status.textContent = "Schlägerweiten gespeichert.";
            status.style.display = "block";
            status.classList.remove("status-error");
            setTimeout(() => {
                status.style.display = "none";
            }, 2000);
        }
    }

    function getRecommendedClub(targetDistanceMeters) {
        let bestClub = null;
        let bestDiff = Infinity;

        for (const club of clubs) {
            const diff = Math.abs(club.distance - targetDistanceMeters);
            if (diff < bestDiff) {
                bestDiff = diff;
                bestClub = club;
            }
        }
        return bestClub;
    }

    function highlightClubByName(name) {
        const rows = document.querySelectorAll("#clubTable tbody tr");
        rows.forEach(row => {
            const rowName = row.getAttribute("data-club-name");
            if (rowName === name) {
                row.classList.add("club-highlight");
            } else {
                row.classList.remove("club-highlight");
            }
        });
    }

    function renderClubTable() {
        const tbody = document.querySelector("#clubTable tbody");
        tbody.innerHTML = "";

        clubs.forEach((club, index) => {
            const tr = document.createElement("tr");
            tr.setAttribute("data-club-name", club.name);

            const tdName = document.createElement("td");
            tdName.textContent = club.name;
            tdName.className = "club-name";

            const tdDist = document.createElement("td");
            const input = document.createElement("input");
            input.type = "number";
            input.min = "1";
            input.step = "1";
            const displayDist = Math.round(fromMeters(club.distance));
            input.value = displayDist.toString();
            input.className = "club-input";
            input.setAttribute("data-index", index);
            tdDist.appendChild(input);

            const tdAction = document.createElement("td");
            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.className = "delete-btn";
            delBtn.textContent = "✕";
            delBtn.setAttribute("data-index", index);
            tdAction.appendChild(delBtn);

            tr.appendChild(tdName);
            tr.appendChild(tdDist);
            tr.appendChild(tdAction);
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll(".club-input").forEach(input => {
            input.addEventListener("change", (e) => {
                const idx = parseInt(e.target.getAttribute("data-index"), 10);
                let val = parseFloat(e.target.value);

                if (isNaN(val) || val <= 0) {
                    e.target.value = Math.round(fromMeters(clubs[idx].distance)).toString();
                    return;
                }

                clubs[idx].distance = toMeters(val);
                saveClubs();
                renderClubSelect();
                populateRoundClubSelects();
            });
        });

        tbody.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const idx = parseInt(e.target.getAttribute("data-index"), 10);
                clubs.splice(idx, 1);
                saveClubs();
                renderClubTable();
                renderClubSelect();
                populateRoundClubSelects();
            });
        });
    }

    function renderClubSelect() {
        const select = document.getElementById("clubSelect");
        if (!select) return;

        select.innerHTML = "";
        clubs.forEach((club, index) => {
            const opt = document.createElement("option");
            opt.value = index.toString();
            opt.textContent = club.name;
            select.appendChild(opt);
        });
    }

    function renderRoundTable() {
        const tbody = document.getElementById("roundTableBody");
        tbody.innerHTML = "";

        for (let i = 1; i <= 18; i++) {
            const tr = document.createElement("tr");

            const tdHole = document.createElement("td");
            tdHole.textContent = i.toString();

            const tdDist = document.createElement("td");
            const distInput = document.createElement("input");
            distInput.type = "number";
            distInput.min = "1";
            distInput.step = "1";
            distInput.className = "round-input";
            distInput.id = `round-distance-${i}`;
            tdDist.appendChild(distInput);

            const tdPar = document.createElement("td");
            const parInput = document.createElement("input");
            parInput.type = "number";
            parInput.min = "3";
            parInput.max = "6";
            parInput.step = "1";
            parInput.className = "round-input";
            parInput.id = `round-par-${i}`;
            tdPar.appendChild(parInput);

            const tdClub = document.createElement("td");
            const clubSelect = document.createElement("select");
            clubSelect.className = "round-select round-club-select";
            clubSelect.setAttribute("data-hole", i.toString());
            tdClub.appendChild(clubSelect);

            const tdScore = document.createElement("td");
            const scoreInput = document.createElement("input");
            scoreInput.type = "number";
            scoreInput.min = "1";
            scoreInput.step = "1";
            scoreInput.className = "round-input";
            scoreInput.id = `round-score-${i}`;
            tdScore.appendChild(scoreInput);

            const tdPutts = document.createElement("td");
            const puttsInput = document.createElement("input");
            puttsInput.type = "number";
            puttsInput.min = "0";
            puttsInput.step = "1";
            puttsInput.className = "round-input";
            puttsInput.id = `round-putts-${i}`;
            tdPutts.appendChild(puttsInput);

            const tdGIR = document.createElement("td");
            tdGIR.className = "checkbox-center";
            const girCheckbox = document.createElement("input");
            girCheckbox.type = "checkbox";
            girCheckbox.id = `round-gir-${i}`;
            tdGIR.appendChild(girCheckbox);

            const tdFIR = document.createElement("td");
            tdFIR.className = "checkbox-center";
            const firCheckbox = document.createElement("input");
            firCheckbox.type = "checkbox";
            firCheckbox.id = `round-fir-${i}`;
            tdFIR.appendChild(firCheckbox);

            tr.appendChild(tdHole);
            tr.appendChild(tdDist);
            tr.appendChild(tdPar);
            tr.appendChild(tdClub);
            tr.appendChild(tdScore);
            tr.appendChild(tdPutts);
            tr.appendChild(tdGIR);
            tr.appendChild(tdFIR);
            tbody.appendChild(tr);
        }

        populateRoundClubSelects();
    }

    function populateRoundClubSelects() {
        const selects = document.querySelectorAll(".round-club-select");
        selects.forEach(select => {
            const prevValue = select.value;
            select.innerHTML = "";

            const emptyOpt = document.createElement("option");
            emptyOpt.value = "";
            emptyOpt.textContent = "-";
            select.appendChild(emptyOpt);

            clubs.forEach(club => {
                const opt = document.createElement("option");
                opt.value = club.name;
                opt.textContent = club.name;
                select.appendChild(opt);
            });

            if (prevValue) {
                const found = Array.from(select.options).some(o => o.value === prevValue);
                if (found) {
                    select.value = prevValue;
                }
            }
        });
    }

    function exportRoundAsCSV() {
        let csv = "Hole,Distance,Par,Club,Score,Putts,GIR,FIR\n";
        let hasData = false;

        for (let i = 1; i <= 18; i++) {
            const distInput = document.getElementById(`round-distance-${i}`);
            const parInput = document.getElementById(`round-par-${i}`);
            const scoreInput = document.getElementById(`round-score-${i}`);
            const puttsInput = document.getElementById(`round-putts-${i}`);
            const girCheckbox = document.getElementById(`round-gir-${i}`);
            const firCheckbox = document.getElementById(`round-fir-${i}`);
            const select = document.querySelector(`.round-club-select[data-hole="${i}"]`);

            const distance = distInput && distInput.value ? distInput.value : "";
            const par = parInput && parInput.value ? parInput.value : "";
            const score = scoreInput && scoreInput.value ? scoreInput.value : "";
            const putts = puttsInput && puttsInput.value ? puttsInput.value : "";
            const gir = girCheckbox && girCheckbox.checked ? "1" : "";
            const fir = firCheckbox && firCheckbox.checked ? "1" : "";
            const club = select && select.value ? select.value : "";

            if (distance || par || score || putts || gir || fir || club) {
                hasData = true;
            }

            const row = [
                i,
                distance,
                par,
                `"${club.replace(/"/g, '""')}"`,
                score,
                putts,
                gir,
                fir
            ].join(",");

            csv += row + "\n";
        }

        if (!hasData) {
            alert("Keine Rundendaten zum Exportieren vorhanden.");
            return;
        }

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "golf_runde.csv";

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function updateUnitLabels() {
        const unitText = unit === "m" ? "m" : "yd";
        const ids = [
            "unitLabelHome",
            "unitLabelHeight",
            "unitLabelBag",
            "unitLabelBagTable",
            "unitLabelNewClub",
            "unitLabelShot",
            "unitLabelRound"
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = unitText;
        });
    }

    function setupLogin() {
        const overlay = document.getElementById("loginOverlay");
        const pwInput = document.getElementById("loginPassword");
        const btn = document.getElementById("loginButton");
        const err = document.getElementById("loginError");

        function authorize() {
            const entered = pwInput.value || "";
            if (entered === ACCESS_PASSWORD) {
                localStorage.setItem(LOGIN_STORAGE_KEY, "ok");
                overlay.style.display = "none";
            } else {
                err.textContent = "Falsches Passwort.";
            }
        }

        const stored = localStorage.getItem(LOGIN_STORAGE_KEY);
        if (stored === "ok") {
            overlay.style.display = "none";
            return;
        }

        btn.addEventListener("click", authorize);
        pwInput.addEventListener("keyup", (e) => {
            if (e.key === "Enter") {
                authorize();
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        // LOGIN
        setupLogin();

        // DOM References
        const distanceInput = document.getElementById("distanceInput");
        const windSelect = document.getElementById("windSelect");
        const heightInput = document.getElementById("heightInput");
        const calcButton = document.getElementById("calcButton");
        const resultDiv = document.getElementById("result");

        const shotDistanceInput = document.getElementById("shotDistanceInput");
        const saveShotButton = document.getElementById("saveShotButton");
        const calibrationStatus = document.getElementById("calibrationStatus");

        const newClubNameInput = document.getElementById("newClubNameInput");
        const newClubDistanceInput = document.getElementById("newClubDistanceInput");
        const addClubButton = document.getElementById("addClubButton");
        const addClubStatus = document.getElementById("addClubStatus");

        const analyzeRoundButton = document.getElementById("analyzeRoundButton");
        const exportRoundButton = document.getElementById("exportRoundButton");
        const resetRoundButton = document.getElementById("resetRoundButton");
        const roundSummary = document.getElementById("roundSummary");

        const unitSelect = document.getElementById("unitSelect");
        const windFactorInput = document.getElementById("windFactorInput");

        // Load settings & data
        loadSettings();
        loadClubs();

        // Apply settings to UI
        if (unitSelect) unitSelect.value = unit;
        if (windFactorInput) windFactorInput.value = windFactor.toString();
        updateUnitLabels();

        renderClubTable();
        renderClubSelect();
        renderRoundTable();

        function showResultText(text, empty = false) {
            resultDiv.textContent = text;
            resultDiv.className = empty ? "result-empty" : "";
        }

        // Empfehlung (Home)
        calcButton.addEventListener("click", () => {
            const rawDistance = parseFloat(distanceInput.value);

            if (isNaN(rawDistance) || rawDistance <= 0) {
                showResultText("Bitte eine gültige Distanz eingeben.");
                return;
            }

            const distanceMeters = toMeters(rawDistance);

            const windBaseMeters = parseInt(windSelect.value, 10) || 0;
            const windMeters = windBaseMeters * windFactor;

            const heightVal = parseFloat(heightInput.value);
            const heightMeters = isNaN(heightVal) ? 0 : toMeters(heightVal);

            const effectiveMeters = distanceMeters + windMeters + heightMeters;

            const club = getRecommendedClub(effectiveMeters);
            if (club) {
                const displayEffective = Math.round(fromMeters(effectiveMeters));
                const unitText = unit === "m" ? "m" : "yd";
                showResultText(
                    `Empfehlung: ${club.name} (Ø ${Math.round(fromMeters(club.distance))} ${unitText}) – effektive Distanz ca. ${displayEffective} ${unitText} (inkl. Wind/Höhe).`
                );
                highlightClubByName(club.name);
            } else {
                showResultText("Kein passender Schläger gefunden.");
            }
        });

        distanceInput.addEventListener("keyup", (e) => {
            if (e.key === "Enter") {
                calcButton.click();
            }
        });

        // Kalibrierung
        saveShotButton.addEventListener("click", () => {
            if (!clubs.length) return;

            const idx = parseInt(document.getElementById("clubSelect").value, 10);
            const shotVal = parseFloat(shotDistanceInput.value);

            if (isNaN(shotVal) || shotVal <= 0) {
                calibrationStatus.textContent = "Bitte eine gültige Distanz für den Schlag eingeben.";
                calibrationStatus.style.display = "block";
                calibrationStatus.classList.add("status-error");
                setTimeout(() => {
                    calibrationStatus.style.display = "none";
                    calibrationStatus.classList.remove("status-error");
                }, 2500);
                return;
            }

            const shotMeters = toMeters(shotVal);
            const club = clubs[idx];
            const old = club.distance;

            const updated = Math.round((old * 2 + shotMeters) / 3);
            club.distance = updated;

            saveClubs();
            renderClubTable();
            renderClubSelect();
            populateRoundClubSelects();

            calibrationStatus.textContent = `Kalibriert: ${club.name} von ${Math.round(fromMeters(old))} auf ${Math.round(fromMeters(updated))} ${unit === "m" ? "m" : "yd"} angepasst.`;
            calibrationStatus.style.display = "block";
            calibrationStatus.classList.remove("status-error");

            setTimeout(() => {
                calibrationStatus.style.display = "none";
            }, 2500);

            shotDistanceInput.value = "";
        });

        // Schläger hinzufügen
        addClubButton.addEventListener("click", () => {
            const name = (newClubNameInput.value || "").trim();
            const distVal = parseFloat(newClubDistanceInput.value);

            if (!name) {
                addClubStatus.textContent = "Bitte einen Schlägernamen eingeben.";
                addClubStatus.style.display = "block";
                addClubStatus.classList.add("status-error");
                setTimeout(() => {
                    addClubStatus.style.display = "none";
                    addClubStatus.classList.remove("status-error");
                }, 2500);
                return;
            }
            if (isNaN(distVal) || distVal <= 0) {
                addClubStatus.textContent = "Bitte eine gültige Distanz eingeben.";
                addClubStatus.style.display = "block";
                addClubStatus.classList.add("status-error");
                setTimeout(() => {
                    addClubStatus.style.display = "none";
                    addClubStatus.classList.remove("status-error");
                }, 2500);
                return;
            }

            const distMeters = toMeters(distVal);
            clubs.push({ name: name, distance: distMeters });
            saveClubs();
            renderClubTable();
            renderClubSelect();
            populateRoundClubSelects();

            addClubStatus.textContent = `Schläger "${name}" hinzugefügt.`;
            addClubStatus.style.display = "block";
            addClubStatus.classList.remove("status-error");
            setTimeout(() => {
                addClubStatus.style.display = "none";
            }, 2500);

            newClubNameInput.value = "";
            newClubDistanceInput.value = "";
        });

        // Runde auswerten
        analyzeRoundButton.addEventListener("click", () => {
            let totalScore = 0;
            let totalPar = 0;
            let holesPlayed = 0;

            let sumPutts = 0;
            let holesWithPutts = 0;

            let girCount = 0;
            let girHoles = 0;
            let firCount = 0;
            let firHoles = 0;

            const clubUsage = {};

            for (let i = 1; i <= 18; i++) {
                const parInput = document.getElementById(`round-par-${i}`);
                const scoreInput = document.getElementById(`round-score-${i}`);
                const puttsInput = document.getElementById(`round-putts-${i}`);
                const girCheckbox = document.getElementById(`round-gir-${i}`);
                const firCheckbox = document.getElementById(`round-fir-${i}`);
                const select = document.querySelector(`.round-club-select[data-hole="${i}"]`);

                const parVal = parseInt(parInput.value, 10);
                const scoreVal = parseInt(scoreInput.value, 10);
                const puttsVal = parseInt(puttsInput.value, 10);

                if (!isNaN(scoreVal) && scoreVal > 0) {
                    totalScore += scoreVal;
                    holesPlayed++;
                }

                if (!isNaN(parVal) && parVal > 0) {
                    totalPar += parVal;
                    girHoles++;
                    firHoles++;
                }

                if (!isNaN(puttsVal) && puttsVal >= 0) {
                    sumPutts += puttsVal;
                    holesWithPutts++;
                }

                if (girCheckbox && girCheckbox.checked) {
                    girCount++;
                }
                if (firCheckbox && firCheckbox.checked) {
                    firCount++;
                }

                if (select && select.value) {
                    clubUsage[select.value] = (clubUsage[select.value] || 0) + 1;
                }
            }

            let summaryText = "";

            if (holesPlayed === 0) {
                summaryText = "Noch keine Scores eingetragen.";
            } else {
                summaryText = `Gespielte Löcher: <strong>${holesPlayed}</strong>, Gesamtscore: <strong>${totalScore}</strong>`;
                if (totalPar > 0) {
                    const diff = totalScore - totalPar;
                    const diffText = diff > 0 ? "+" + diff : (diff < 0 ? diff.toString() : "E");
                    summaryText += ` (Par ${totalPar}, <strong>${diffText}</strong>)`;
                }
            }

            if (holesWithPutts > 0) {
                const avgPutts = (sumPutts / holesWithPutts).toFixed(1);
                summaryText += `<br/>Putts: <strong>${sumPutts}</strong> (Ø ${avgPutts} pro Loch)`;
            }

            if (girHoles > 0) {
                const girPct = Math.round((girCount / girHoles) * 100);
                summaryText += `<br/>GIR: <strong>${girCount}/${girHoles}</strong> (${girPct}%)`;
            }

            if (firHoles > 0) {
                const firPct = Math.round((firCount / firHoles) * 100);
                summaryText += `<br/>FIR: <strong>${firCount}/${firHoles}</strong> (${firPct}%)`;
            }

            const usageEntries = Object.entries(clubUsage);
            if (usageEntries.length > 0) {
                const usageText = usageEntries
                    .sort((a, b) => b[1] - a[1])
                    .map(([clubName, count]) => `${clubName}: ${count}×`)
                    .join(", ");
                summaryText += `<br/>Meist genutzte Schläger: <strong>${usageText}</strong>`;
            }

            roundSummary.innerHTML = summaryText;
        });

        // Runde zurücksetzen
        resetRoundButton.addEventListener("click", () => {
            for (let i = 1; i <= 18; i++) {
                const ids = [
                    `round-distance-${i}`,
                    `round-par-${i}`,
                    `round-score-${i}`,
                    `round-putts-${i}`
                ];
                ids.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.value = "";
                });

                const girCheckbox = document.getElementById(`round-gir-${i}`);
                const firCheckbox = document.getElementById(`round-fir-${i}`);
                if (girCheckbox) girCheckbox.checked = false;
                if (firCheckbox) firCheckbox.checked = false;

                const select = document.querySelector(`.round-club-select[data-hole="${i}"]`);
                if (select) select.value = "";
            }
            roundSummary.innerHTML = "";
        });

        // CSV Export
        exportRoundButton.addEventListener("click", () => {
            exportRoundAsCSV();
        });

        // NAVIGATION (Tabs)
        document.querySelectorAll(".navbar button").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".navbar button")
                    .forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                const id = btn.getAttribute("data-tab");
                document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
                document.getElementById(id).classList.add("active");
            });
        });

        // SETTINGS – Einheit
        if (unitSelect) {
            unitSelect.addEventListener("change", () => {
                unit = unitSelect.value === "yd" ? "yd" : "m";
                saveSettings();
                updateUnitLabels();
                renderClubTable();
            });
        }

        // SETTINGS – Wind-Faktor
        if (windFactorInput) {
            windFactorInput.addEventListener("change", () => {
                const val = parseFloat(windFactorInput.value);
                if (!isNaN(val) && val >= 0) {
                    windFactor = val;
                    saveSettings();
                } else {
                    windFactorInput.value = windFactor.toString();
                }
            });
        }

        // Service Worker registrieren
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js").catch((err) => {
                console.warn("Service Worker Registrierung fehlgeschlagen:", err);
            });
        }

        // Init
        updateUnitLabels();
        showResultText("", true);
    });
</script>

</body>
</html>
